<?php

$params = getopt('', [
    'project-name:',
    'query-type:',
]);

$projectName = isset($params['project-name']) ? $params['project-name'] : null;
$queryType = isset($params['query-type']) ? $params['query-type'] : null;
if ($queryType)
    list($project, $queryType) = explode('\\', $queryType);

if ($projectName) {
    mkdir($projectName, 0700);

    $configFile = <<<FILE
<?php

return [
    'connection' => [
        'driver' => 'mysql',
        'host' => 'localhost',
        'dbname' => '',
        'user' => 'root',
        'pass' => '',
    ],
    // ... another db connection
];
FILE;

    mkdir("$projectName/config", 0700);
    file_put_contents("$projectName/config/db.php", $configFile);

    mkdir("$projectName/models", 0700);
}

if ($queryType === 'model') {
    $simpleModelExampleFile = <<<FILE
<?php

namespace $project\\models;

use $project\\records\\ActiveRecord;

class SimpleModelExample extends ActiveRecord
{
    public function table()
    {
        return 'table_name';
    }

    public function fields()
    {
        return [];
    }
}
FILE;

    file_put_contents("$project/models/SimpleModelExample.php", $simpleModelExampleFile);
}
else if ($queryType === 'view') {
    $viewExampleFile = <<<FILE
<?php

namespace $project\\models;

use $project\\records\\ActiveRecord;
use suql\\syntax\\Field;

class ViewExample extends ActiveRecord
{
    public function query()
    {
        return 'view_example_name';
    }

    public function table()
    {
        return 'table_from_name';
    }

    public function fields()
    {
        return [];
    }

    public function view()
    {
        return
            \$this
                ->join('another_table')
                    ->select([
                        'field_name',
                        new Field(['another_field_name' => 'alias_for_it'], [
                            'modifier_name',
                        ])
                    ]);
    }
}
FILE;

    file_put_contents("$project/models/ViewExample.php", $viewExampleFile);
}
else if ($queryType === 'sub') {
    $subQueryExampleFile = <<<FILE
<?php

namespace $project\\models;

use $project\\records\\ActiveRecord;

class SubQueryExample extends ActiveRecord
{
    public function query()
    {
        return 'sub_query_example_name';
    }

    public function table()
    {
        return InnerQueryModel::all();
    }

    public function fields()
    {
        return [];
    }

    public function view()
    {
        return
            \$this
                ->select([
                    'field_name',
                    'another_field_name',
                ]);
    }
}
FILE;

    file_put_contents("$project/models/SubQueryExample.php", $subQueryExampleFile);
}
else if ($queryType === 'raw') {
    $rawQueryExampleFile = <<<FILE
<?php

namespace $project\\models;

use $project\\records\\ActiveRecord;

class RawQueryExample extends ActiveRecord
{
    public function query()
    {
        return 'raw_query_name';
    }

    public function table()
    {
        return null;
    }

    public function fields()
    {
        return [];
    }

    public function view()
    {
        return
            \$this
                ->select([
                    '2 * 2',
                    "'Yuriy' as author",
                ]);
    }
}
FILE;

    file_put_contents("$project/models/RawQueryExample.php", $rawQueryExampleFile);
}
else if ($queryType === 'union') {
    $unionQueryExampleFile = <<<FILE
<?php

namespace $project\\models;

use suql\\syntax\\Field;
use $project\\records\\ActiveRecord;

class UnionQueryExample extends ActiveRecord
{
    public function query()
    {
        return 'union_query_name';
    }

    public function table()
    {
        return null;
    }

    public function fields()
    {
        return [];
    }

    public function view()
    {
        return
            \$this->union([
                OneModel::all()
                    ->select([
                        new Field(['field_name' => 'alias_for_it'], [
                            'modifier_name'
                        ])
                    ])
                    ->as('alias_for_this_query'),
                AnotherModel::all()
                    ->select([
                        new Field(['field_name' => 'alias_for_it'], [
                            'modifier_name'
                        ])
                    ])
                    ->as('alias_for_this_query'),
            ]);
    }
}
FILE;

    file_put_contents("$project/models/UnionQueryExample.php", $unionQueryExampleFile);
}

if ($projectName) {
    $activeRecordFile = <<<FILE
<?php

namespace $projectName\\records;

use suql\\syntax\\SuQL;
use $projectName\\modifiers\\CustomModifierExample;
use suql\\db\\Container;

abstract class ActiveRecord extends SuQL
{
    protected static \$schemeClass = '$projectName\\\\schema\\\\AppScheme';
    protected static \$builderClass = 'suql\\\\builder\\\\MySQLBuilder';

    protected function modifierList()
    {
        return array_merge(
            parent::modifierList(),
            [
                CustomModifierExample::class,
            ]
        );
    }

    public function getDb()
    {
        return Container::get('connection');
    }
}
FILE;

    mkdir("$projectName/records", 0700);
    file_put_contents("$projectName/records/ActiveRecord.php", $activeRecordFile);

    $appSchemeFile = <<<FILE
<?php

namespace $projectName\\schema;

use suql\\core\\Scheme;

class AppScheme extends Scheme
{
    function __construct()
    {
        // \$this->addTableList([
        //     'users' => 'u',
        //     'user_group' => 'ug',
        //     'groups' => 'g',
        // ]);

        // \$this->rel('{{u}}', '{{ug}}', '{{u}}.id = {{ug}}.user_id');
        // \$this->rel('{{ug}}', '{{g}}', '{{ug}}.group_id = {{g}}.id');
    }
}
FILE;

    mkdir("$projectName/schema", 0700);
    file_put_contents("$projectName/schema/AppScheme.php", $appSchemeFile);

    $customModifierExampleFile = <<<FILE
<?php

namespace $projectName\\modifiers;

class CustomModifierExample
{
    public static function mod_modifierName(\$ofield, \$params)
    {
        // ... Code here
    }
}
FILE;

    mkdir("$projectName/modifiers", 0700);
    file_put_contents("$projectName/modifiers/CustomModifierExample.php", $customModifierExampleFile);
}